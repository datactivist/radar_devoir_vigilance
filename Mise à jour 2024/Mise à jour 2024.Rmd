---
title: "Liste des entreprises soumises au devoir de vigilance"
subtitle: "Mise à jour de 2024"
date: Dernière modification le `r format(Sys.time(), '%d %B %Y')`
output:
    rmarkdown::html_document:
      #number_sections: true
      theme: paper
      toc: true
      toc_depth: 4
      collapsed: true
      smooth_scroll: true
      code_folding: hide
      css: styles.css
      includes:
        in_header: header.html
        after_body: footer.html
---

```{r setup, include=FALSE}
# Paramètres généraux
knitr::opts_chunk$set(
	eval = TRUE,
	echo = FALSE,
	fig.align = "center",
	fig.show = "hold",
	message = FALSE,
	warning = FALSE,
	collapse = TRUE,
	out.width = "100%",
	results = "asis"
)
```

```{r logo}
# Logo Datactivist haut de page
htmltools::img(src = "https://nextcloud.datactivist.coop/s/o53wzfMNnFosQni/preview", 
               alt = 'logo', 
               style = 'position:absolute; top:0; left:0.5; padding-top:10px;') #padding=taille des espaces autour
```

# Introduction

# Import des données


## Base Sirene

Étant donné le poids des données et pour ne pas ralentir l'exécution de cette page, les données de la base SIRENE ont été traitées dans le script *'Pre-run_Sirene.R'*. 

Le 14 août 2024, les unités légales de 5000 à 9999 salariés, et celles de plus de 100000 salariés ont été importées puis rassemblées en une seule base, sur laquelle les filtres et calculs de cette page vont être appliqués.

```{r}
library(tidyverse)
library(readxl)

# Données
sirene <- read_csv("data/in/entreprises_plus5000-salaries_SIRENE.csv")


##--- Filtres

# Filtre sur la forme juridique
forme_juri <- sirene |> 
    filter(`Nature juridique de l'unité légale` == "SAS, société par actions simplifiée" | 
               `Nature juridique de l'unité légale` == "Société européenne" |
               `Nature juridique de l'unité légale` == "Société en commandite par actions" |
               grepl("SA", `Nature juridique de l'unité légale`) == TRUE)

# Filtre sur le nombre de salariés
nb_salaries <- sirene |> 
    filter(`Tranche de l'effectif de l'unité légale` == "5 000 à 9 999 salariés" | 
               `Tranche de l'effectif de l'unité légale` == "10 000 salariés et plus" |
               `Tranche de l'effectif de l'établissement` == "5 000 à 9 999 salariés" | 
               `Tranche de l'effectif de l'établissement` == "10 000 salariés et plus")

# Deux conditions remplies
forme_juri_salaries <- intersect(forme_juri, nb_salaries) |> 
    select(-c(`Tranche de l'effectif de l'établissement triable`, `Tranche de l'effectif de l'unité légale triable`, 
              `Année de la tranche d'effectif de l'établissement`, 
              `Date du dernier traitement de l'unité légale`:`Catégorie juridique de l'unité légale`))

# UNITÉS LÉGALES DDV
unites_legales_ddv_sirene <- forme_juri_salaries |> 
    mutate(nombre_etablissements = n(), .by = SIREN) |> 
    distinct(SIREN, `Dénomination de l'unité légale`, `Tranche de l'effectif de l'unité légale`, 
             `Année de la tranche de l'effectif de l'unité légale`, `Nature juridique de l'unité légale`, nombre_etablissements)
rio::export(unites_legales_ddv_sirene, "data/out/unites-legales_ddv_SIRENE.csv")
```

## Base Orbis{.tabset}

Les données de la base Orbis ont été extraites une première fois le 17 juillet 2024 depuis la page [orbis-r1-bvdinfo-com.acces-distant.sciencespo.fr](https://orbis-r1-bvdinfo-com.acces-distant.sciencespo.fr/version-20240621-3-2/Orbis/1/Companies/List), via un identifiant donnant accès aux données fermées. Les filtres suivants ont été appliqués : 

- **Statut** : *Entreprises actives*, ou en *Situation inconnue*, pour un total de **373.396.812** entreprises ;
- **Forme juridique nationale** :  *SA - SA (France), SA directoire (France), SCA - SCA (France), Société Anonyme (France), Société européenne (France), Société par actions simplifiée - SAS (France)*, pour un total de **532.075** entreprises ;
- **Nombre d'employés** : *5.000 et plus* pour les trois dernières années disponibles (lorsqu'il y a au moins 1 des 3 années disponible), pour un total de **21.588** entreprises (7.827 si on sélectionne les entreprises dont les comptes des 3 dernières années sont tous connus).

Seules 265 entreprises remplissent les caractéristiques listées (139 si on sélectionne les entreprises dont les comptes des 3 dernières années sont tous connus). 

<br>

Le 22 août 2024, une nouvelle extraction a été faite en appliquant les mêmes filtres :

- **Statut** : *Entreprises actives*, ou en *Situation inconnue*, pour un total de **380.602.334** entreprises ;
- **Forme juridique nationale** :  *SA - SA (France), SA directoire (France), SCA - SCA (France), Société Anonyme (France), Société européenne (France), Société par actions simplifiée - SAS (France)*, pour un total de **2.071.794** entreprises ;
- **Nombre d'employés** : *5.000 et plus* pour les trois dernières années disponibles (lorsqu'il y a au moins 1 des 3 années disponible), pour un total de **15.346** entreprises.

258 entreprises remplissent les caractéristiques listées.

```{r}
library(jsonlite)

# Données
orbis_old <- fromJSON(txt = "data/in/data_orbis_18-07.json", flatten = T)
orbis <- fromJSON(txt = "data/in/data_orbis_22-08.json", flatten = T)

# test <- symdiff(orbis$`Nom de l'entreprise Latin alphabet`, orbis_old$`Nom de l'entreprise Latin alphabet`)
# test <- cbind(orbis |> 
#                   select(`Nom de l'entreprise Latin alphabet`) |> 
#                   arrange(`Nom de l'entreprise Latin alphabet`), 
#               orbis_new |> 
#                   select(`Nom de l'entreprise Latin alphabet`) |> 
#                   arrange(`Nom de l'entreprise Latin alphabet`)) |> 
#     rename(old = 1, new = 2) |> 
#     mutate(is_diff = ifelse(old != new, 1, 0))

##--- Filtres

entreprises_ddv_orbis <- full_join(orbis, orbis_old) |> 
    filter(`Dernière année disp.` >= 2012) |> 
    # mise en forme données d'effectifs
    mutate(`EffectifsDernière année disp.` = str_remove_all(`EffectifsDernière année disp.`, ",|n.d."),
           `EffectifsDernière année disp.` = as.numeric(na_if(`EffectifsDernière année disp.`, "")),
           `EffectifsAnnée - 1` = str_remove_all(`EffectifsAnnée - 1`, ",|n.d."),
           `EffectifsAnnée - 1` = as.numeric(na_if(`EffectifsAnnée - 1`, "")),
           `EffectifsAnnée - 2` = str_remove_all(`EffectifsAnnée - 2`, ",|n.d."),
           `EffectifsAnnée - 2` = as.numeric(na_if(`EffectifsAnnée - 2`, ""))) |> 
    # règle de décision sur les effectifs
    mutate(derniers_effectifs = coalesce(`EffectifsDernière année disp.`,`EffectifsAnnée - 1`,`EffectifsAnnée - 2`),
           effectifs_22_23_sup_5000 = case_when(`Dernière année disp.` == 2023 & 
                                                    `EffectifsDernière année disp.` > 5000 & 
                                                    `EffectifsAnnée - 1` > 5000 ~ TRUE,
                                                `Dernière année disp.` == 2023 & 
                                                    `EffectifsDernière année disp.` <= 5000 & 
                                                    `EffectifsAnnée - 1` <= 5000 ~ FALSE,
                                                .default = NA_real_),
           derniers_effectifs_sup_5000 = ifelse(derniers_effectifs > 5000, TRUE, FALSE)) |> 
    # extraction SIRET
    mutate(`Code d'identifiant` = strsplit(as.character(`Code d'identifiant`), ";"),
           `Libellé d'identifiant` = strsplit(as.character(`Libellé d'identifiant`), ";")) |> 
    unnest(c(`Code d'identifiant`, `Libellé d'identifiant`)) |> 
    filter(`Libellé d'identifiant` == "SIREN number" | `Libellé d'identifiant` == "SIRET number") |>
    arrange(desc(`Libellé d'identifiant`)) |> 
    slice(1, .by = `Nom de l'entreprise Latin alphabet`) |> 
    mutate(SIREN = substr(`Code d'identifiant`, 1, 9))

#table(entreprises_ddv_orbis$effectifs_22_23_sup_5000)
#table(entreprises_ddv_orbis$derniers_effectifs_sup_5000)

# Entreprises non concernées par le DDV
entreprises_non_ddv <- entreprises_ddv_orbis |> 
    filter(effectifs_22_23_sup_5000 == FALSE, derniers_effectifs_sup_5000 == FALSE)

# Entreprises concerncées par le DDV
entreprises_ddv_orbis <- entreprises_ddv_orbis |> 
    filter(effectifs_22_23_sup_5000 == TRUE | derniers_effectifs_sup_5000 == TRUE)
```

Entre les deux extractions, de nouvelles entreprises apparaissent dans la liste, et d'autres n'y sont plus. Les entreprises sont les suivantes : 

### Anciennes entreprises

```{r}
# Filtre sur les entreprises dans l'extraction du 17 juillet et pas du 22 août
library(DT)
anciennes_entreprises <- setdiff(orbis_old$`Nom de l'entreprise Latin alphabet`, orbis$`Nom de l'entreprise Latin alphabet`) |> 
    as.data.frame() |> 
    rename(`Nom de l'entreprise Latin alphabet` = 1) |> 
    left_join(orbis_old, by = "Nom de l'entreprise Latin alphabet") |> 
    select(-c(`Dernière mise à jour - Statut...`:`Previous SIRET number...`))# |> 
    #filter(`Dernière année disp.` >= 2012)

entps_inactives <- anciennes_entreprises |> 
    filter(`Dernière année disp.` < 2012) |> 
    select(`Nom de l'entreprise Latin alphabet`) |> 
    t()
```

`r nrow(anciennes_entreprises)` entreprises apparaissaient dans l'extraction du 17 juillet mais pas dans celle du 22 août. Parmi celles-ci,  la dernière année disponible des effectifs remonte jusqu'à 1992. Une recherche manuelle a été menée sur les entreprises avec les années disponibles d'effectifs les plus anciennes. 

Ainsi, les entreprises dont la date est antérieure à 2012 ont été cessées ou radiées et ne sont plus en activité aujourd'hui, il s'agit des entreprises suivantes qui sont donc retirées des données Orbis d'entreprises soumises au devoir de vigilance : `r entps_inactives`.

```{r}
datatable(anciennes_entreprises, options = list(pageLength = 5, scrollX = TRUE))
```

### Nouvelles entreprises

```{r}
nouvelles_entreprises <- setdiff(orbis$`Nom de l'entreprise Latin alphabet`, orbis_old$`Nom de l'entreprise Latin alphabet`) |> 
    as.data.frame() |> 
    rename(`Nom de l'entreprise Latin alphabet` = 1) |> 
    left_join(orbis, by = "Nom de l'entreprise Latin alphabet")
```

`r nrow(nouvelles_entreprises)` entreprises apparaissent dans l'extraction du 22 août mais pas dans celle du 17 juillet.

```{r}
datatable(nouvelles_entreprises, options = list(pageLength = 5, scrollX = TRUE))
```


# Liste d'entreprises soumises au devoir de vigilance{.tabset}

Les règles de décision suivantes ont été appliquées par source de données pour obtenir la liste d'entreprises soumises au devoir de vigilance : 

- ***données Sirene*** : 
    - *'Nature juridique de l'unité légale'* a l'une des valeurs suivantes : "SAS, société par actions simplifiée", "Société européenne", "Société en commandite par actions", ou contient le mot "SA" ;
    - *'Tranche de l'effectif de l'unité légale'* ou *'Tranche de l'effectif de l'établissement'* a l'une des valeurs suivantes : "5 000 à 9 999 salariés" ou "10 000 salariés et plus".
- ***données Orbis*** : 
    - *'Forme juridique nationale'* a l'une des valeurs suivantes (filtre appliqué dès la recherche sur le portail Orbis) : "SA - SA (France)", "SA directoire (France)", "SCA - SCA (France)", "Société Anonyme (France)", "Société européenne (France)", "Société par actions simplifiée - SAS (France)" ;
    - *'Nombre d'employés'* avec l'un de ces deux cas : les effectifs des deux dernières années sont supérieurs à 5000 et la dernière année disponible est 2023 (il s'agit donc des effectifs de 2022 et 2023), ou lorsque la dernière année disponible n'est pas 2023 (2022 ou antérieur) les derniers effectifs disponibles sont supérieurs à 5000.


Pour les données Orbis, les entreprises des 2 extractions ont été combinées pour ne passer à côté d'aucune entreprise concernée, en laissant la possibilité d'un tri manuel à partir de cette liste. Seules les entreprises dont la dernière année des effectifs est antérieure à 2012 ont été écartées, puisqu'il s'agit d'entreprises aujourd'hui inactives. 


```{r eval=FALSE, include=FALSE}
# Données
table3 <- data.frame(orbis = c(0, anti_join(entreprises_ddv_orbis, unites_legales_ddv_sirene, by = "SIREN") |> nrow() + inner_join(unites_legales_ddv_sirene, entreprises_ddv_orbis, by = "SIREN") |> nrow(),
                              inner_join(unites_legales_ddv_sirene, entreprises_ddv_orbis, by = "SIREN") |> nrow()),
                    sirene = c(anti_join(unites_legales_ddv_sirene, entreprises_ddv_orbis, by = "SIREN") |> nrow() + inner_join(unites_legales_ddv_sirene, entreprises_ddv_orbis, by = "SIREN") |> nrow(), 0,
                               inner_join(unites_legales_ddv_sirene, entreprises_ddv_orbis, by = "SIREN") |> nrow())) |> 
    slice(rep(1:n(), times = c(sirene[1], orbis[2], sirene[3]))) |> 
    mutate_all(na_if, 0) |> 
    as.list()

# Graphique
library(ggVennDiagram)
ggVennDiagram(table3, label_alpha = 0) 

  labs(title = "Ce que vendent les commerces répondants", subtitle = " ") +
  scale_fill_gradient(low = "#F4FAFE", high = "#4981BF") +
  guides(fill = guide_legend(title = "Nombre de \ncommerces")) + 
  theme(legend.position = "top",
        strip.text.x = element_text(size = 12, face = "bold"),
        strip.background = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        axis.text = element_blank(),
        legend.text = ggplot2::element_text(size = 18,color = "#222222"), 
        text = element_text(family = "Montserrat", size = 12),
        plot.title = ggplot2::element_text(size = 17, face = "bold", color = "#222222"), 
        plot.caption = ggplot2::element_text(face = "italic", size = 18, 
                                             color = "#666666", margin = ggplot2::margin(9, 0, 9, 0)), 
        plot.title.position = "plot", 
        plot.caption.position = "plot")
```


## Sirene uniquement


```{r}
# Base Sirene uniquement
ddv_sirene <- anti_join(unites_legales_ddv_sirene, entreprises_ddv_orbis, by = "SIREN") |> 
    arrange(`Dénomination de l'unité légale`)
rio::export(ddv_sirene, "data/out/ddv_sirene_uniquement.csv")

# Bouton téléchargement
library(xfun)
library(downloadthis)
download_file(
  path = "data/out/ddv_sirene_uniquement.csv",
  output_name = "ddv_sirene_uniquement",
  button_label = "Données",
  has_icon = TRUE,
  icon = "fa fa-download",
  self_contained = FALSE,
  class = "button")
```

`r nrow(ddv_sirene)` entreprises remplissent les conditions sur la forme juridique et les effectifs dans les données Sirene. 

<br>

```{r}
# Affichage des données
datatable(ddv_sirene, options = list(pageLength = 10, scrollX = TRUE))
```

## Orbis uniquement


```{r}
# Base Sirene uniquement
ddv_orbis <- anti_join(entreprises_ddv_orbis, unites_legales_ddv_sirene, by = "SIREN") |> 
    arrange(`Nom de l'entreprise Latin alphabet`)
rio::export(ddv_orbis, "data/out/ddv_orbis_uniquement.csv")

# Bouton téléchargement
download_file(
  path = "data/out/ddv_orbis_uniquement.csv",
  output_name = "ddv_orbis_uniquement",
  button_label = "Données",
  has_icon = TRUE,
  icon = "fa fa-download",
  self_contained = FALSE,
  class = "button")
```

`r nrow(ddv_orbis)` entreprises remplissent les conditions sur la forme juridique et les effectifs dans les données Orbis. 

<br>

```{r}
# Affichage des données
datatable(ddv_orbis, options = list(pageLength = 10, scrollX = TRUE))
```


## Entreprises communes


```{r}
# Entreprises communes aux bases Sirene et Orbis
ddv_sirene_orbis <- inner_join(unites_legales_ddv_sirene, entreprises_ddv_orbis, by = "SIREN") |> 
    arrange(`Dénomination de l'unité légale`)
rio::export(ddv_sirene_orbis, "data/out/ddv_sirene_orbis.csv")

# Bouton téléchargement
download_file(
  path = "data/out/ddv_sirene_orbis.csv",
  output_name = "ddv_sirene_orbis",
  button_label = "Données",
  has_icon = TRUE,
  icon = "fa fa-download",
  self_contained = FALSE,
  class = "button")
```

`r nrow(ddv_sirene_orbis)` entreprises remplissent les conditions sur la forme juridique et les effectifs dans les données Orbis comme dans les données Sirene. 

<br>

```{r}
# Affichage des données
datatable(ddv_sirene_orbis, options = list(pageLength = 10, scrollX = TRUE))
```

## Liste finale


```{r}
library(tm)
# Entreprises communes aux bases Sirene et Orbis
ddv_sirene_orbis_full <- full_join(unites_legales_ddv_sirene |> mutate(Source = "Sirene"), 
                                   entreprises_ddv_orbis |> mutate(Source = "Orbis"), 
                                   by = "SIREN", suffix = c("_Sirene", "_Orbis")) |> 
    mutate(Source = case_when(Source_Sirene == "Sirene" & Source_Orbis == "Orbis" ~ "Sirene et Orbis",
                              Source_Sirene == "Sirene" & is.na(Source_Orbis) ~ "Sirene",
                              Source_Orbis == "Orbis" & is.na(Source_Sirene) ~ "Orbis",
                              .default = NA_character_),
           nom_entreprise = coalesce(`Dénomination de l'unité légale`, `Nom de l'entreprise Latin alphabet`),
           SIRET_Orbis = removeWords(`Code d'identifiant`, "-"),
           annee_maj_forme_juridique_Orbis = na_if(`Dernière mise à jour - Statut...`, "")) |> 
    select(-c(Source_Sirene, Source_Orbis, `Dénomination de l'unité légale`, `Nom de l'entreprise Latin alphabet`)) |> 
    rename(effectifs_unite_legale_Sirene = `Tranche de l'effectif de l'unité légale`,
           annee_effectifs_ul_Sirene = `Année de la tranche de l'effectif de l'unité légale`,
           annee_derniers_effectifs_Orbis = `Dernière année disp.`,
           derniers_effectifs_Orbis = `EffectifsDernière année disp.`,
           derniers_effectifs_moins1_Orbis = `EffectifsAnnée - 1`,
           derniers_effectifs_moins2_Orbis = `EffectifsAnnée - 2`,
           forme_juridique_Sirene = `Nature juridique de l'unité légale`,
           forme_juridique_Orbis = `Statut juridique standardisé`,
           SIREN_Sirene = SIREN,
           nombre_etablissements_Sirene = nombre_etablissements) |> 
    select(Source, nom_entreprise, SIREN_Sirene, SIRET_Orbis, annee_effectifs_ul_Sirene, effectifs_unite_legale_Sirene, 
           annee_derniers_effectifs_Orbis:derniers_effectifs_moins2_Orbis, forme_juridique_Sirene, annee_maj_forme_juridique_Orbis, 
           forme_juridique_Orbis, nombre_etablissements_Sirene) |> 
    arrange(nom_entreprise)
rio::export(ddv_sirene_orbis_full, "data/out/ddv_sirene_orbis_full.csv")

# Bouton téléchargement
download_file(
  path = "data/out/ddv_sirene_orbis_full.csv",
  output_name = "ddv_sirene_orbis_full",
  button_label = "Données",
  has_icon = TRUE,
  icon = "fa fa-download",
  self_contained = FALSE,
  class = "button")
```

Finalement, ce sont `r nrow(ddv_sirene_orbis_full)` entreprises qui remplissent les conditions. 

À partir des données Orbis des effectifs en 2022 et 2023, 3 entreprises ont été écartées, ne remplissant pas les conditions (il s'agit des entreprises `r entreprises_non_ddv |> select("Nom de l'entreprise Latin alphabet") |> t()`). Une vérification a été faite pour s'assurer que ces entreprises ne soient pas dans la liste créée à partir des données Sirene, qui est moins restrictive sur les effectifs étant donné que seuls les effectifs de 2021 sont disponibles. 

<br>

```{r}
# Affichage des données
datatable(ddv_sirene_orbis_full, options = list(pageLength = 10, scrollX = TRUE))
```


```{r eval=FALSE, include=FALSE}
# Brouillon

## Cas particuliers

### Données Orbis

+ **Effectifs inférieurs à 50 les 2 dernières années disponibles dans les données, et supérieurs à 150.000 personnes**

RALLYE, FINATIS, FONCIERE EURIS
```







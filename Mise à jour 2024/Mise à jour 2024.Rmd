---
title: "Liste des entreprises soumises au devoir de vigilance"
subtitle: "Mise à jour de 2024"
date: Dernière modification le `r format(Sys.time(), '%d %B %Y')`
output:
    rmarkdown::html_document:
      #number_sections: true
      theme: paper
      toc: true
      toc_depth: 4
      collapsed: true
      smooth_scroll: true
      css: styles.css
      includes:
        in_header: header.html
        after_body: footer.html
---

```{r setup, include=FALSE}
# Paramètres généraux
knitr::opts_chunk$set(
	eval = TRUE,
	echo = FALSE,
	fig.align = "center",
	fig.show = "hold",
	message = FALSE,
	warning = FALSE,
	collapse = TRUE,
	out.width = "100%",
	results = "asis"
)
```

```{r logo}
# Logo Datactivist haut de page
htmltools::img(src = "https://nextcloud.datactivist.coop/s/o53wzfMNnFosQni/preview", 
               alt = 'logo', 
               style = 'position:absolute; top:0; left:0.5; padding-top:10px;') #padding=taille des espaces autour
```

# Introduction

# Sélection des données

Comparaison du nombre d'entreprises selon la source : 

- Orbis : 23.795.040 entreprises le 18 juillet 2024 ;
- Sirene (V3) : 38.833.027 entreprises le 18 juillet 2024 ;


## Base INPI

```{r}
library(tidyverse)
library(readxl)
data_inpi <- read_excel("data/data_inpi.xlsx", skip = 1)
```

## Base Pappers


```{r}
library(htm2txt)
library(rvest)

test <- read_html("https://www.pappers.fr/recherche?forme_juridique=5710%2C5599%2C5505%2C5510%2C5515%2C5522%2C5525%2C5530%2C5532%2C5542%2C5543%2C5546%2C5547%2C5548%2C5551%2C5552%2C5553%2C5554%2C5555%2C5558%2C5559%2C5560%2C5605%2C5720%2C5610%2C5615%2C5625%2C5622%2C5642%2C5643%2C5646%2C5648%2C5651%2C5652%2C5653%2C5654%2C5655%2C5660%2C5659%2C5658%2C5699%2C5308%2C5309%2C5800&effectifs_min=5000&effectifs_max=500000") |> 
    html_nodes('body')  |> html_nodes('table') |> html_table(dec = ",")

test <- gettxt("https://www.pappers.fr/recherche?forme_juridique=5710%2C5599%2C5505%2C5510%2C5515%2C5522%2C5525%2C5530%2C5532%2C5542%2C5543%2C5546%2C5547%2C5548%2C5551%2C5552%2C5553%2C5554%2C5555%2C5558%2C5559%2C5560%2C5605%2C5720%2C5610%2C5615%2C5625%2C5622%2C5642%2C5643%2C5646%2C5648%2C5651%2C5652%2C5653%2C5654%2C5655%2C5660%2C5659%2C5658%2C5699%2C5308%2C5309%2C5800&effectifs_min=5000&effectifs_max=500000") |> #import page par page
    rename(text = 1) |> 
    mutate(text = strsplit(as.character(text), "\n")) |> unnest(text) |> #split les éléments séparés par des "\n"
    filter(row_number() ==  10 | #nom de conférence
               grepl("Acronym:", text) ==  TRUE | 
               grepl("Source:", text) ==  TRUE | 
               grepl("Rank:", text) ==  TRUE, #champs que l'on garde
           grepl("DBLP", text) ==  FALSE) |> #retrait de la ligne contenant ce string
    mutate(text = case_when(row_number() ==  1 ~ paste("Title:", text), TRUE ~ text), #ajout du préfixe "titre:"
           champ = str_extract(text, "^[a-zA-Z0-9_]*"), #dans une nouvelle colonne ce qui est avant ":"
           value = str_extract(text, "(?< = : )[^\n]*")) |> #dans une nouvelle colonne ce qui est après ": "
    select(-text) |> t() |> row_to_names(row_number = 1) |> data.frame() |> #transpose puis 1ère ligne en nom de colonnes
    pivot_longer(cols = -c(Title, Acronym), names_to = "number", values_to = "value", names_prefix = "Source|Rank") |> # format long pour rank et source quand multiples
    mutate(col = case_when(row_number() %% 2 ==  0 ~ "rank",
                           row_number() %% 2 ==  1 ~ "source")) |> #
    pivot_wider(names_from = col, values_from = value) |> 
    select(-number) |> mutate(core_id = .x)

# Gestion des Na et mise au format tabulaire
core_histo <- core_millesime[core_millesime !=  "NA"] # replace NA by NULL
core_histo <- rrapply::rrapply(core_histo, condition = Negate(is.null), how = "prune") #remove NULL
core_histo <- core_histo |> bind_rows()

```


## Base Sirene

## Base Orbis

Les données de la base Orbis ont été téléchargées le 17 juillet 2024 sur [orbis-r1-bvdinfo-com.acces-distant.sciencespo.fr](https://orbis-r1-bvdinfo-com.acces-distant.sciencespo.fr/version-20240621-3-2/Orbis/1/Companies/List), via un identifiant donnant accès aux données fermées. Les filtres suivants ont été appliqués : 

- **Statut** : *Entreprises actives*, ou en *Situation inconnue*, pour un total de **373.396.812** entreprises ;
- **Forme juridique** :  *SA - SA (France), SA directoire (France), SCA - SCA (France), Société Anonyme (France), Société européenne (France), Société par actions simplifiée - SAS (France)*, pour un total de **532.075** entreprises ;
- **Nombre d'employés** : *5.000 et plus* pour les trois dernières années disponibles (lorsqu'il y a au moins 1 des 3 années disponible), pour un total de **21.588** entreprises (7.827 si on sélectionne les entreprises dont les comptes des 3 dernières années sont tous connus).

Seules 265 entreprises remplissent les caractéristiques listées (139 si on sélectionne les entreprises dont les comptes des 3 dernières années sont tous connus). 

```{r}
library(jsonlite)
orbis <- fromJSON(txt = "data/data_orbis.json", flatten = T)
```


## Titre de niveau 2

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor. Cras elementum ultrices diam. Maecenas ligula massa, varius a, semper congue, euismod non, mi. Proin porttitor, orci nec nonummy molestie, enim est eleifend mi, non fermentum diam nisl sit amet erat. Duis semper. Duis arcu massa, scelerisque vitae, consequat in, pretium a, enim. Pellentesque congue. Ut in risus volutpat libero pharetra tempor. Cras vestibulum bibendum augue. Praesent egestas leo in pede. Praesent blandit odio eu enim. Pellentesque sed dui ut augue blandit sodales. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Aliquam nibh. Mauris ac mauris sed pede pellentesque fermentum. Maecenas adipiscing ante non diam sodales hendrerit. 

## Les petites astuces

Quelques paramètres à changer si vous voulez un R Markdown légèrement différent : 

- `<br>` saute une ligne entre 2 éléments 
- `number_sections: true` dans l'en-tête de ce document numérote automatiquement les parties et sous-parties (retirer le `#` dans l'en-tête pour l'utiliser)
- `toc: false` supprime la table des matières (table of contents, *toc*) qui s'affiche par défaut au début du document avec une profondeur maximale de 4 actuellement
- `date: "1er janvier 2023"` affiche une date fixe car entrée comme un texte. Actuellement c'est la date du jour où le rapport est généré qui apparaît automatiquement dans l'en-tête du document
- **texte en gras**, *texte en italique*, ***texte en gras italique***

# Une deuxième section divisée en 3

<div class = "row">
  
<div class = "col-md-4">
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor. Cras elementum ultrices diam. Maecenas ligula massa, varius a, semper congue, euismod non, mi.
</div>
  
<div class = "col-md-4">
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor. Cras elementum ultrices diam. Maecenas ligula massa, varius a, semper congue, euismod non, mi.
</div>
  
<div class = "col-md-4">
```{r graph}
library(tidyverse)
ggplot( mtcars, aes(x=mpg)) + 
  geom_histogram(fill="skyblue", alpha=0.5) + 
  theme_minimal()
```
</div>
</div>

## Faire ressortir du texte dans une boxe


<br>

<style>
div.blue { background-color:#fff1eb; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">

**Ma boxe**

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor. Cras elementum ultrices diam. Maecenas ligula massa, varius a, semper congue, euismod non, mi. Proin porttitor, orci nec nonummy molestie, enim est eleifend mi, non fermentum diam nisl sit amet erat. Duis semper. Duis arcu massa, scelerisque vitae, consequat in, pretium a, enim.

</div>


---
title: "Liste des entreprises soumises au devoir de vigilance"
subtitle: "Mise à jour de 2024"
date: Dernière modification le `r format(Sys.time(), '%d %B %Y')`
output:
    rmarkdown::html_document:
      #number_sections: true
      theme: paper
      toc: true
      toc_depth: 4
      collapsed: true
      smooth_scroll: true
      css: styles.css
      includes:
        in_header: header.html
        after_body: footer.html
---

```{r setup, include=FALSE}
# Paramètres généraux
knitr::opts_chunk$set(
	eval = TRUE,
	echo = FALSE,
	fig.align = "center",
	fig.show = "hold",
	message = FALSE,
	warning = FALSE,
	collapse = TRUE,
	out.width = "100%",
	results = "asis"
)
```

```{r logo}
# Logo Datactivist haut de page
htmltools::img(src = "https://nextcloud.datactivist.coop/s/o53wzfMNnFosQni/preview", 
               alt = 'logo', 
               style = 'position:absolute; top:0; left:0.5; padding-top:10px;') #padding=taille des espaces autour
```

# Introduction

# Sélection des données

Comparaison du nombre d'entreprises selon la source : 

- Orbis : 23.795.040 entreprises le 18 juillet 2024 ;
- Sirene (V3) : 38.833.027 entreprises le 18 juillet 2024 ;



## Base Sirene

Les données de la base SIRENE ont été traitées dans le script *'Pre-run_Sirene.R'*, étant donné le poids des données et pour ne pas ralentir l'exécution de cette page. 

Le 14 août 2024, les unités légales de 5000 à 9999 salariés, et celles de plus de 100000 salariés ont été importées puis rassemblées en une seule base, sur laquelle les filtres et calculs de cette page vont être appliqués.

```{r}
library(tidyverse)
library(readxl)

# Données
sirene <- read_csv("data/in/entreprises_plus5000-salaries_SIRENE.csv")


##--- Filtres

# Filtre sur la forme juridique
forme_juri <- sirene |> 
    filter(`Nature juridique de l'unité légale` == "SAS, société par actions simplifiée" | 
               `Nature juridique de l'unité légale` == "Société européenne" |
               `Nature juridique de l'unité légale` == "Société en commandite par actions" |
               grepl("SA", `Nature juridique de l'unité légale`) == TRUE)

# Filtre sur le nombre de salariés
nb_salaries <- sirene |> 
    filter(`Tranche de l'effectif de l'unité légale` == "5 000 à 9 999 salariés" | 
               `Tranche de l'effectif de l'unité légale` == "10 000 salariés et plus" |
               `Tranche de l'effectif de l'établissement` == "5 000 à 9 999 salariés" | 
               `Tranche de l'effectif de l'établissement` == "10 000 salariés et plus")

# Deux conditions remplies
forme_juri_salaries <- intersect(forme_juri, nb_salaries) |> 
    select(-c(`Tranche de l'effectif de l'établissement triable`, `Tranche de l'effectif de l'unité légale triable`, 
              `Année de la tranche d'effectif de l'établissement`, 
              `Année de la tranche de l'effectif de l'unité légale`:`Catégorie juridique de l'unité légale`))

# UNITÉS LÉGALES DDV
ul_ddv <- forme_juri_salaries |> 
    mutate(nombre_etablissements = n(), .by = SIREN) |> 
    distinct(SIREN, `Dénomination de l'unité légale`, `Tranche de l'effectif de l'unité légale`, 
             `Nature juridique de l'unité légale`, nombre_etablissements)
rio::export(ul_ddv, "data/out/unites-legales_ddv_SIRENE.csv")
```

## Base Orbis

Les données de la base Orbis ont été téléchargées le 17 juillet 2024 sur [orbis-r1-bvdinfo-com.acces-distant.sciencespo.fr](https://orbis-r1-bvdinfo-com.acces-distant.sciencespo.fr/version-20240621-3-2/Orbis/1/Companies/List), via un identifiant donnant accès aux données fermées. Les filtres suivants ont été appliqués : 

- **Statut** : *Entreprises actives*, ou en *Situation inconnue*, pour un total de **373.396.812** entreprises ;
- **Forme juridique** :  *SA - SA (France), SA directoire (France), SCA - SCA (France), Société Anonyme (France), Société européenne (France), Société par actions simplifiée - SAS (France)*, pour un total de **532.075** entreprises ;
- **Nombre d'employés** : *5.000 et plus* pour les trois dernières années disponibles (lorsqu'il y a au moins 1 des 3 années disponible), pour un total de **21.588** entreprises (7.827 si on sélectionne les entreprises dont les comptes des 3 dernières années sont tous connus).

Seules 265 entreprises remplissent les caractéristiques listées (139 si on sélectionne les entreprises dont les comptes des 3 dernières années sont tous connus). 

```{r}
library(jsonlite)

# Données
orbis <- fromJSON(txt = "data/in/data_orbis.json", flatten = T)


##--- Filtres

entreprises_ddv_orbis <- orbis |> 
    filter(`Dernière année disp.` >= 2012) |> 
    # mise en forme données d'effectifs
    mutate(`EffectifsDernière année disp.` = str_remove_all(`EffectifsDernière année disp.`, ",|n.d."),
           `EffectifsDernière année disp.` = as.numeric(na_if(`EffectifsDernière année disp.`, "")),
           `EffectifsAnnée - 1` = str_remove_all(`EffectifsAnnée - 1`, ",|n.d."),
           `EffectifsAnnée - 1` = as.numeric(na_if(`EffectifsAnnée - 1`, "")),
           `EffectifsAnnée - 2` = str_remove_all(`EffectifsAnnée - 2`, ",|n.d."),
           `EffectifsAnnée - 2` = as.numeric(na_if(`EffectifsAnnée - 2`, ""))) |> 
    # règle de décision sur les effectifs
    mutate(derniers_effectifs = coalesce(`EffectifsDernière année disp.`,`EffectifsAnnée - 1`,`EffectifsAnnée - 2`),
           effectifs_22_23_sup_5000 = case_when(`Dernière année disp.` == 2023 & 
                                                    `EffectifsDernière année disp.` > 5000 & 
                                                    `EffectifsAnnée - 1` > 5000 ~ "1",
                                                .default = "0"),
           effectifs_last_sup_5000 = ifelse(derniers_effectifs > 5000, "1", "0")) |> 
    # extraction SIRET
    mutate(`Code d'identifiant` = strsplit(as.character(`Code d'identifiant`), ";"),
           `Libellé d'identifiant` = strsplit(as.character(`Libellé d'identifiant`), ";")) |> 
    unnest(c(`Code d'identifiant`, `Libellé d'identifiant`)) |> 
    filter(`Libellé d'identifiant` == "SIREN number" | `Libellé d'identifiant` == "SIRET number") |>
    arrange(desc(`Libellé d'identifiant`)) |> 
    slice(1, .by = `Nom de l'entreprise Latin alphabet`) |> 
    mutate(SIREN = substr(`Code d'identifiant`, 1, 9))

table(entreprises_ddv_orbis$effectifs_22_23_sup_5000)
table(entreprises_ddv_orbis$effectifs_last_sup_5000)

# Entreprises non concernées par le DDV
entreprises_non_ddv <- entreprises_ddv_orbis |> 
    filter(effectifs_22_23_sup_5000 == "0" & effectifs_last_sup_5000 == "0")
```

## Liste des entreprises soumises au devoir de vigilance

```{r}
# Entreprises communes aux bases Sirene et Orbis
ddv_sirene_orbis <- inner_join(ul_ddv, entreprises_ddv_orbis, by = "SIREN")
```








